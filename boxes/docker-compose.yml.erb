version: '3'
services:
  <%-
    name = s = nil
    box.split("/").each do |part|
      if name
        depend = name
        name = "#{name}_#{part}"
        s = "#{s}/#{part}"
      else
        name = s = part
      end
      next if stage != "build"
  -%>
  <%= name %>:
    image: sandbox-<%= s %>
    build:
      context: boxes/<%= s %>
    <%- if depend %>
    depends_on:
    - <%= depend %>
    <%- end %>
  <%-
    end
   -%>
  run-<%= name %>:
    image: sandbox-run-<%= box %>
    user: ${USER}
  <%- if stage == "build" %>
    depends_on:
    - <%= name %>
  <%- end %>
    build:
      context: boxes/<%= box %>
      dockerfile: Dockerfile-user
      args:
        uid: ${uid}
        user: ${USER}
    tty: true
    stdin_open: true
    working_dir: /work
    volumes:
    - <%= workdir %>:/work
    <%- volumes.split(" ").each do |volume| -%>
    - "<%= volume %>"
    <%- end -%>
