#!/bin/sh

if [ -z "$SANDBOX_ROOT" ]; then
  SANDBOX_ROOT=~/.sandbox
fi
if [ -z "$SANDBOX_PROFILE" ]; then
  SANDBOX_PROFILE="$SANDBOX_ROOT/profile"
fi
if [ -z "$SANDBOXES_DIR" ]; then
  SANDBOXES_DIR=./boxes
fi
if [ -z "$SANDBOX_VOLUME_DIR" ]; then
  SANDBOX_VOLUMES_DIR="$SANDBOX_ROOT/volumes"
fi

DIR=`dirname $0`
BASE=`basename $0`
while :; do
  cd "$DIR"
  [ -L "$DIR/$BASE" ] || break
  DIR=`dirname "$(readlink $DIR/$BASE)"`
done

[ -f "$SANDBOX_PROFILE" ] && . "$SANDBOX_PROFILE"

for OPT in "$@"; do
  case "$OPT" in
    --install )
      [ -L ~/.local/bin/sandbox ] || ln -s `pwd`/sandbox ~/.local/bin/sandbox
      exit
      ;;
    -l )
      cd "$SANDBOXES_DIR"
      find * -type d
      exit
      ;;
    -L )
      cd "$SANDBOXES_DIR"
      find * -type d|ruby -pe '$_ = "#{"  " * $_.count("/")}* #$_"'
      exit
      ;;
    -v )
      [ -n "$VOLUMES" ] && VOLUMES="$VOLUMES "
      VOLUMES="${VOLUMES}$2"
      shift 2
      ;;
  esac
done

BOX="$1"
SERVICE=`echo $BOX|tr \/ _`
export uid
export USER
export HOME
[ -z "$uid" ] && uid=$(id -u)
clean=1
WORKDIR="$SANDBOX_VOLUMES_DIR/${BOX}"

mkdir -p "$WORKDIR"
if [ -f "$SANDBOXES_DIR/$BOX/Dockerfile" ]; then
  DOCKER_DIR="$WORKDIR/.docker/$USER"
  mkdir -p "$DOCKER_DIR"
  erb box="$BOX" boxes_dir="$SANDBOXES_DIR" -T- "$SANDBOXES_DIR/Dockerfile.erb" > "$DOCKER_DIR/Dockerfile"
  erb box="$BOX" workdir="$WORKDIR" volumes="$VOLUMES" -T- "$SANDBOXES_DIR/docker-compose.yml.erb" > "$DOCKER_DIR/docker-compose.yml"
  cd "$DOCKER_DIR"
  docker-compose build || fail
  docker-compose up -d 2>&1| grep "up-to-date$" && clean=0
  docker-compose exec "$SERVICE" bash -l
  [ $clean = 1 ] || exit
  docker-compose down
  exit
fi

if [ -f "$SANDBOXES_DIR/$BOX/vagrant_config.rb" ]; then
  export VAGRANT_CWD="$WORKDIR"
  [ "$(vagrant status|sed -ne '3s/^[^ ]* *\([^ ]*\).*/\1/p')" = running ] && clean=0
  [ $clean = 1 ] && erb box="$BOX" volumes="$VOLUMES" -T- "$SANDBOXES_DIR/Vagrantfile.erb" > "$VAGRANT_CWD/Vagrantfile"
  [ $clean = 1 ] && vagrant up
  vagrant ssh
  [ $clean = 1 ] && vagrant halt
  exit
fi
